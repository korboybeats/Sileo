on:
  push:
    branches:
      - main
  workflow_dispatch:

name: Build and Release
jobs:
  make:
    name: Build and Release Sileo
    env:
      PHONE_IP: ${{ secrets.PHONE_IP }}
      SILEOTMP: ${{ github.workspace }}/sileo_build
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Prepare Procursus Directory
        run: |
          sudo mkdir -p /opt/procursus
          sudo chown -R $(whoami):admin /opt/procursus

      - name: Cache Procursus Bootstrap
        uses: actions/cache@v4
        id: procursus-cache
        with:
          path: /opt/procursus
          key: ${{ runner.os }}-procursus-debs-v3
          restore-keys: |
            ${{ runner.os }}-procursus-debs-

      - name: Setup Procursus Bootstrap (install)
        if: steps.procursus-cache.outputs.cache-hit != 'true'
        run: |
          wget https://apt.procurs.us/bootstraps/big_sur/bootstrap-darwin-arm64.tar.zst
          sudo gtar --preserve-permissions -xkf ./bootstrap-darwin-arm64.tar.zst -C /
          echo '/opt/procursus/sbin:/opt/procursus/bin' >> $GITHUB_PATH
          PATH=/opt/procursus/sbin:/opt/procursus/bin:$PATH sudo /opt/procursus/bin/apt update
          sudo /opt/procursus/bin/apt -V full-upgrade -y --allow-downgrades -oDpkg::Options::=--force-confdef -oDpkg::Options::=--force-confnew
        continue-on-error: true

      - name: Cache Xcode Build
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/sileo_build
          key: ${{ runner.os }}-xcode-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-xcode-build-
    
      - name: Upgrade and install
        run: |
          sudo /opt/procursus/bin/apt install zstd apt-utils ldid xz-utils bzip2 lz4 -y --allow-downgrades -oDpkg::Options::=--force-confdef -oDpkg::Options::=--force-confnew
      
        
      - name: Add Procursus to PATH
        run: |
          echo '/opt/procursus/sbin:/opt/procursus/bin' >> $GITHUB_PATH

      - name: Select Correct Xcode (16.4)
        run: |
          sudo xcode-select --switch /Applications/Xcode_16.4.app

      - name: Build Sileo (iphoneos-arm64)
        run: |
          make package NIGHTLY=0 DEBUG=0 ALL_BOOTSTRAPS=1 SILEO_PLATFORM=iphoneos-arm64 SILEOTMP=${{ github.workspace }}/sileo_build
      
      - name: Fix Cache Permissions
        run: |
          sudo chown -R $(whoami):admin /opt/procursus
      
      - name: Get Build Information
        id: build_info
        run: |
          DEB_PATH=$(find ./packages -name "*.deb")
          echo "deb_path=$DEB_PATH" >> $GITHUB_OUTPUT

      - name: Upload Deb
        uses: actions/upload-artifact@v4
        with:
          name: sileo-deb
          path: ${{ steps.build_info.outputs.deb_path }}

      - name: Install on Phone
        if: env.PHONE_IP != ''
        env:
          PHONE_IP: ${{ secrets.PHONE_IP }}
          PHONE_PORT: ${{ secrets.PHONE_PORT }}
          PHONE_USER: ${{ secrets.PHONE_USER }}
          PHONE_PASS: ${{ secrets.PHONE_PASS }}
          PHONE_KEY: ${{ secrets.PHONE_KEY }}
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
          DEB_PATH: ${{ steps.build_info.outputs.deb_path }}
        run: |
          brew install sshpass || true

          # Setup SSH args
          SSH_PORT=${PHONE_PORT:-22}
          SSH_ARGS="-o StrictHostKeyChecking=no -o ConnectTimeout=10 -p $SSH_PORT"

          # Create key file if provided
          if [ -n "$PHONE_KEY" ]; then
            echo "$PHONE_KEY" > key_file
            chmod 600 key_file
            SSH_CMD="ssh -i key_file $SSH_ARGS"
            SCP_CMD="scp -i key_file -P $SSH_PORT -o StrictHostKeyChecking=no -o ConnectTimeout=10"
          elif [ -n "$PHONE_PASS" ]; then
            SSH_CMD="sshpass -p $PHONE_PASS ssh $SSH_ARGS"
            SCP_CMD="sshpass -p $PHONE_PASS scp -P $SSH_PORT -o StrictHostKeyChecking=no -o ConnectTimeout=10"
          else
            echo "No SSH credentials provided"
            exit 1
          fi

          # Try direct connection first
          echo "Trying direct connection to $PHONE_IP..."
          if $SSH_CMD "$PHONE_USER@$PHONE_IP" "echo 'Direct connection successful'" 2>/dev/null; then
            echo "Direct connection works, installing..."
          else
            echo "Direct connection failed"
            if [ -n "$TAILSCALE_AUTHKEY" ]; then
              echo "Setting up Tailscale..."
              brew install tailscale
              sudo tailscaled > /dev/null 2>&1 &
              sleep 5
              sudo tailscale up --authkey=$TAILSCALE_AUTHKEY --hostname=github-runner --accept-routes
              echo "Tailscale connected, retrying..."
            else
              echo "No Tailscale authkey, cannot fallback"
              exit 1
            fi
          fi

          # Copy and install
          $SCP_CMD "$DEB_PATH" "$PHONE_USER@$PHONE_IP:/tmp/sileo.deb"
          $SSH_CMD "$PHONE_USER@$PHONE_IP" "dpkg -i /tmp/sileo.deb && rm /tmp/sileo.deb && (killall Sileo || true) && open org.coolstar.SileoStore && echo 'Installed Sileo update!'"